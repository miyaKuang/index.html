import pandas as pd
import matplotlib.pyplot as plt

# ----------------------------
# Data
# ----------------------------
data = {
    'Subtype': ['PTCL-NOS (9702)']*5 + ['AITL (9705)']*4 + ['ALCL (9714)']*5 + ['PTCL-ALL (9702, 9705, 9714)']*5,
    'Ethnicity': [
        'Non-Hispanic White', 'Non-Hispanic Black', 'Hispanic', 'Asian/Pacific Islander', 'American Indian',
        'Non-Hispanic White', 'Non-Hispanic Black', 'Hispanic', 'Asian/Pacific Islander',
        'Non-Hispanic White', 'Non-Hispanic Black', 'Hispanic', 'Asian/Pacific Islander', 'American Indian',
        'Non-Hispanic White', 'Non-Hispanic Black', 'Hispanic', 'Asian/Pacific Islander', 'American Indian'
    ],
    'Rate': [
        0.34, 0.58, 0.36, 0.35, 0.44,
        0.16, 0.16, 0.16, 0.18,
        0.21, 0.28, 0.19, 0.14, 0.35,
        0.71, 1.01, 0.71, 0.67, 0.93
    ],
    'Lower_CI': [
        0.32, 0.51, 0.33, 0.31, 0.28,
        0.15, 0.12, 0.14, 0.16,
        0.20, 0.23, 0.17, 0.12, 0.20,
        0.69, 0.93, 0.68, 0.62, 0.68
    ],
    'Upper_CI': [
        0.36, 0.65, 0.39, 0.38, 0.67,
        0.17, 0.20, 0.18, 0.20,
        0.23, 0.33, 0.21, 0.17, 0.57,
        0.74, 1.11, 0.75, 0.72, 1.24
    ]
}
df = pd.DataFrame(data)

# Color map
color_map = {
    'Non-Hispanic White': '#808080',
    'Non-Hispanic Black': '#6A3D9A',
    'Hispanic': '#33A02C',
    'Asian/Pacific Islander': '#E31A1C',
    'American Indian': '#FF7F00'
}

# ----------------------------
# Plot
# ----------------------------
fig, ax = plt.subplots(figsize=(14, 8))  # horizontal stretch + a bit taller

subtypes = df['Subtype'].unique()
x_positions, x_labels = [], []

current_x = 0
bar_width = 0.8                     # original bar width
gap_between_bars = 0.01             # tiny, visible gap between bars
gap_between_groups = 2.0            # space between the big four subgroups

# Track bar centers by subgroup (for precise bracket edges)
group_centers = {st: [] for st in subtypes}

for subtype in subtypes:
    subset = df[df['Subtype'] == subtype]
    for _, row in subset.iterrows():
        ax.bar(
            current_x,
            row['Rate'],
            color=color_map[row['Ethnicity']],
            width=bar_width,
            yerr=[[row['Rate'] - row['Lower_CI']], [row['Upper_CI'] - row['Rate']]],
            capsize=4
        )
        x_positions.append(current_x)
        x_labels.append(row['Ethnicity'])
        group_centers[subtype].append(current_x)
        current_x += 1 + gap_between_bars
    current_x += gap_between_groups

# Axes formatting
ax.set_ylabel("Average annual age-adjusted incidence rate (per 100,000)", fontsize=11)
ax.set_xticks(x_positions)
ax.set_xticklabels(x_labels, rotation=45, ha='right')

# Brackets + labels directly above each subgroup, bold labels for the big four
y_bracket = ax.get_ylim()[1] + 0.01
label_height = y_bracket + 0.015

for subtype in subtypes:
    centers = group_centers[subtype]
    left_edge  = min(centers) - bar_width/2
    right_edge = max(centers) + bar_width/2
    mid_point  = (left_edge + right_edge) / 2

    # Invisible guide lines at subgroup edges (kept invisible)
    ax.vlines([left_edge, right_edge], ymin=ax.get_ylim()[0], ymax=ax.get_ylim()[1],
              colors='black', alpha=0.0, linewidth=0.5)

    # Bracket
    ax.plot([left_edge, left_edge, right_edge, right_edge],
            [y_bracket, y_bracket + 0.015, y_bracket + 0.015, y_bracket],
            color='black', lw=1.5)
    # Bold subgroup label
    ax.text(mid_point, label_height, subtype, ha='center', va='bottom',
            fontsize=ax.xaxis.get_label().get_size(), fontweight='bold')

# Clean frame & grid style (horizontal grid only)
ax.spines['top'].set_visible(False)
ax.spines['right'].set_visible(False)
ax.yaxis.grid(True)
ax.xaxis.grid(False)

# Title: updated wording, size 20, not bold
ax.set_title(
    "PTCL-ALL (9702, 9705, 9714) average annual age adjusted incidence by Race/ethnicity\n"
    "for both sexes categorized by PTCL subtype",
    fontsize=20,
    fontweight='normal',
    pad=30
)

plt.tight_layout()
plt.show()

# ----------------------------
# (Optional) Separate color legend figure
# Uncomment to generate a standalone legend image
# ----------------------------
# fig_legend, ax_legend = plt.subplots(figsize=(3, 2))
# handles = [plt.Rectangle((0,0), 1, 1, color=color_map[k]) for k in color_map]
# labels  = list(color_map.keys())
# ax_legend.legend(handles, labels, title="Race/Ethnicity", loc='center')
# ax_legend.axis('off')
# plt.tight_layout()
# plt.show()
